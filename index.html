<!doctype html>
<!-- Tristan Simulator — All-in-one prototype
  Features:
  - Tile-based overworld (grass tiles) with biome tints
  - Cave tiles -> maze-like dungeon (Stone.jpg), smooth 360° movement
  - Visible enemies in dungeon that wander and chase; collision triggers battle
  - Village tiles -> side-scrolling village with houses and NPCs & shop
  - Bottom HUD with HP, Gold, Level, Quests, Items button (opens inventory overlay)
  - Shop to buy Map (unlocks minimap) and Potions
  - Inventory with item descriptions
  - Pokémon-style battle overlay (enemy at top, player bottom, shake animation)
-->
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tristan Simulator — Prototype</title>
<style>
  :root{
    --panel: rgba(0,0,0,0.55);
    --accent:#caa53a;
    --font: system-ui, "Segoe UI", Roboto, Arial;
  }
  html,body{height:100%;margin:0;font-family:var(--font);background:#000;color:#eef}
  #app{height:100%;display:flex;align-items:center;justify-content:center;padding:12px}
  .game-window{width:1000px;max-width:96vw;height:720px;border-radius:10px;overflow:hidden;background:linear-gradient(#071028,#02040a);box-shadow:0 20px 60px rgba(0,0,0,0.8);position:relative}

  /* Title */
  #title-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:80}
  .logo{font-size:48px;font-weight:900;margin-bottom:8px}
  .menu{display:flex;flex-direction:column;gap:10px}
  .btn{background:var(--panel);padding:12px 20px;border-radius:10px;cursor:pointer;text-align:center;border:1px solid rgba(255,255,255,0.03)}
  .btn:hover{transform:translateY(-3px)}

  /* World area */
  #world{position:absolute;inset:0;top:0;display:flex;flex-direction:column}
  .map-area{flex:1;display:flex}
  #tile-canvas{flex:1;position:relative;background:#222;overflow:hidden} /* tiles go here */
  #sidebar{width:260px;background:linear-gradient(180deg,rgba(0,0,0,0.6),#000);padding:8px;box-sizing:border-box;color:#fff}

  /* bottom HUD */
  #hud{height:160px;background:linear-gradient(180deg,rgba(0,0,0,0.6),#000);display:flex;align-items:center;justify-content:space-between;padding:12px;box-sizing:border-box}
  .hud-left{display:flex;gap:12px;align-items:center}
  .hpbar{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.03)}
  .currency{display:flex;align-items:center;gap:8px}
  #hud .btn{padding:8px 12px;border-radius:8px;min-width:auto}

  /* tiles */
  .tile-grid{position:absolute;inset:0;display:grid;grid-template-columns:repeat(var(--cols), 1fr);grid-auto-rows: calc(100% / var(--rows));}
  .tile{background-image:url('IMAGES/Grass.jpg');background-size:cover;background-position:center;border:1px solid rgba(0,0,0,0.06);box-sizing:border-box}
  .tile.cave{background-image:url('IMAGES/Stone.jpg');background-size:cover}
  .tile.village{background-image:url('IMAGES/Grass.jpg');background-size:cover}
  .tile.tinted{mix-blend-mode:multiply} /* we'll set tint background-color */

  /* visual player/enemy sprites (overlayed and used in dungeon too) */
  #visual-player, #visual-enemy{position:absolute;width:48px;height:48px;background-repeat:no-repeat;background-position:center;background-size:contain;pointer-events:none;z-index:30;transition:transform 0.06s linear}
  #visual-player{background-image:url('IMAGES/Tristan.png');transform-origin:center}
  #visual-enemy{background-image:url('IMAGES/enemy.png');}

  /* side-scroll village */
  #village-view{position:absolute;inset:0;display:none;flex-direction:column;background:linear-gradient(#7fb870,#6aa25a);z-index:50}
  #village-stage{flex:1;overflow:hidden;position:relative;background:linear-gradient(#7fb870,#3f8f4a)}
  .house{position:absolute;width:220px;height:160px;background:url('IMAGES/House.png') center/contain no-repeat;bottom:40px}
  .villager{position:absolute;width:48px;height:64px;background-size:cover;background-repeat:no-repeat}

  /* dungeon overlaying container */
  #dungeon-view{position:absolute;inset:0;display:none;background:#111;z-index:40}
  .dungeon-canvas{position:absolute;inset:0;overflow:hidden;background-image:url('IMAGES/Stone.jpg');background-size:cover;background-position:center}

  /* battle overlay */
  #battle-overlay{position:absolute;inset:0;display:none;align-items:flex-end;justify-content:center;z-index:90;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.85))}
  .battle-box{width:820px;background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .battle-images{display:flex;justify-content:space-between;align-items:flex-end}
  .battle-images img{max-width:340px;max-height:160px;object-fit:contain}
  .battle-text{background:rgba(0,0,0,0.7);padding:10px;border-radius:8px;color:#fff;min-height:48px;display:flex;align-items:center}
  .battle-actions{display:flex;gap:8px}
  .battle-actions .btn{flex:1}

  /* inventory overlay */
  #inventory{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:420px;background:rgba(0,0,0,0.85);padding:12px;border-radius:10px;color:#fff;display:none;z-index:95}
  #inventory h3{margin:0 0 8px 0}
  .inv-list{max-height:260px;overflow:auto}
  .inv-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .inv-desc{font-size:13px;color:#ccd;margin-top:6px}

  /* minimap */
  #minimap{position:absolute;top:12px;right:12px;width:180px;height:120px;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;color:#fff;z-index:70;display:none;overflow:hidden}
  #minimap pre{margin:0;font-family:monospace;font-size:10px;line-height:10px}

  /* shake animation */
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
  .shake{animation:shake 420ms ease-in-out}

  /* small helpers */
  .small{font-size:13px;color:#cfe}
</style>
</head>
<body>
<div id="app">
  <div class="game-window">

    <!-- Title / menu -->
    <div id="title-screen">
      <div class="logo">Tristan Simulator</div>
      <div class="subtitle small">Wake. Fight. Rule again.</div>
      <div class="menu" style="margin-top:10px">
        <div class="btn" id="btn-new">NEW GAME</div>
        <div class="btn" id="btn-load">LOAD GAME</div>
        <div class="btn" id="btn-tut">TUTORIAL</div>
      </div>
      <div style="margin-top:10px">
        <label class="small"><input id="toggle-music-title" type="checkbox" checked> Music</label>
      </div>
      <audio id="title-audio" loop src="MUSIC/TitleTheme.ogg"></audio>
    </div>

    <!-- World / map -->
    <div id="world">
      <div class="map-area">
        <div id="tile-canvas">
          <!-- tiles grid will be appended by JS -->
          <div id="tile-grid" class="tile-grid" style="--cols:24;--rows:12"></div>
          <!-- overlayed visuals (player, enemies) -->
          <div id="visual-enemy"></div>
          <div id="visual-player"></div>
          <!-- minimap -->
          <div id="minimap"><div class="small">Minimap</div><pre id="minimap-pre"></pre></div>
        </div>

        <div id="sidebar">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="player-name">Tristan</strong><div class="small">Lv <span id="player-lvl">1</span></div>
            </div>
            <div class="currency"><img src="IMAGES/Certified.png" width="24"><div id="gold">0</div></div>
          </div>

          <div style="margin-top:10px">
            <div class="small">HP</div>
            <div class="hpbar" id="hpdisplay">10 / 10</div>
            <div style="margin-top:10px" class="small">XP</div>
            <div class="hpbar" id="xpdisplay">0 XP</div>
            <div style="margin-top:10px" class="small">Quests</div>
            <div class="hpbar small" id="quests">No active quests</div>
          </div>

          <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
            <div class="btn" id="btn-inventory">Items</div>
            <div class="btn" id="btn-map">Open Map</div>
            <div class="btn" id="btn-return">Return to Title</div>
          </div>

          <div style="margin-top:16px" class="small">Tip: Walk onto caves to enter dungeons, villages to enter towns.</div>
          <div style="margin-top:8px" class="small">Biomes change tile tint & enemy types.</div>
        </div>
      </div>

      <!-- bottom HUD -->
      <div id="hud">
        <div class="hud-left">
          <div class="hpbar"><strong>HP</strong> <span id="hud-hp">10/10</span></div>
          <div class="hpbar"><strong>Gold</strong> <img src="IMAGES/Certified.png" width="18" style="vertical-align:middle;margin-left:6px"><span id="hud-gold">0</span></div>
          <div class="hpbar"><strong>Level</strong> <span id="hud-lvl">1</span></div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div id="status" class="small">Status: Exploring</div>
          <div class="btn" id="btn-save">Save</div>
        </div>
      </div>
    </div>

    <!-- Village side-scroller -->
    <div id="village-view">
      <div style="height:60px;padding:10px;color:#fff;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.2)">
        <div id="village-title" class="small">Village</div>
        <div style="display:flex;gap:8px">
          <div class="btn" id="btn-village-return">Leave Village</div>
        </div>
      </div>
      <div id="village-stage"></div>
    </div>

    <!-- Dungeon -->
    <div id="dungeon-view">
      <div style="height:60px;padding:10px;color:#fff;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.25)">
        <div class="small" id="dungeon-title">Dungeon</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="btn" id="btn-dungeon-leave">Leave Dungeon</div>
        </div>
      </div>
      <div class="dungeon-canvas" id="dungeon-canvas"></div>
    </div>

    <!-- Inventory popup -->
    <div id="inventory">
      <h3>Inventory</h3>
      <div class="inv-list" id="inv-list"></div>
      <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
        <div class="btn" id="inv-close">Close</div>
      </div>
    </div>

    <!-- Shop modal (simple) -->
    <div id="shop-modal" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:98;background:rgba(0,0,0,0.9);padding:12px;border-radius:8px;color:#fff;min-width:360px">
      <h3 id="shop-title">Shop</h3>
      <div id="shop-list"></div>
      <div style="margin-top:8px;display:flex;justify-content:flex-end">
        <div class="btn" id="shop-close">Close</div>
      </div>
    </div>

    <!-- Battle overlay -->
    <div id="battle-overlay">
      <div class="battle-box">
        <div class="battle-images">
          <div style="text-align:center">
            <div id="battle-enemy-name" class="small">Enemy</div>
            <img id="battle-enemy-img" src="IMAGES/enemy.png" alt="enemy">
            <div class="small" id="battle-enemy-hp">HP --</div>
          </div>
          <div style="text-align:center">
            <div class="small">You</div>
            <img id="battle-player-img" src="IMAGES/Tristan.png" alt="player">
            <div class="small" id="battle-player-hp">HP --</div>
          </div>
        </div>

        <div class="battle-text" id="battle-log">A wild enemy approaches!</div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="btn" id="battle-fight">FIGHT</div>
          <div class="btn" id="battle-act">ACT</div>
          <div class="btn" id="battle-item">ITEM</div>
          <div class="btn" id="battle-flee">FLEE</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Audio elements -->
<audio id="dungeon-audio" loop src="MUSIC/DungeonTheme.ogg"></audio>

<script>
/* ======== Game Data & State ======== */
const CONFIG = {
  cols: 24, rows: 12,
  tilePx: 48,
  encounterDistance: 32,
  dungeonEnemyCount: 8,
  enemyDropChance: 0.12
};

const BIOMES = [
  {id:'grass', tint:'rgba(34,160,80,0.15)', name:'Grassland'},
  {id:'desert', tint:'rgba(200,160,40,0.18)', name:'Desert'},
  {id:'snow', tint:'rgba(200,220,255,0.16)', name:'Snowland'},
  {id:'swamp', tint:'rgba(20,80,30,0.18)', name:'Swamp'},
  {id:'volcanic', tint:'rgba(160,40,20,0.22)', name:'Volcanic'}
];

const ENEMY_TEMPLATES = {
  grass: {name:'Grunt', hp:8, atk:2, gold:3, act:'It snarls.'},
  desert:{name:'Sandling', hp:9, atk:3, gold:4, act:'It spits sand.'},
  snow:  {name:'Frostling', hp:7, atk:2, gold:4, act:'It breathes cold.'},
  swamp: {name:'Bogbeast', hp:10, atk:2, gold:5, act:'It smells foul.'},
  volcanic:{name:'Flare', hp:12, atk:4, gold:6, act:'It radiates heat.'}
};

const TILE_TYPES = {G:'grass', C:'cave', V:'village', P:'path'};

const ASSETS = {
  grass:'IMAGES/Grass.jpg', stone:'IMAGES/Stone.jpg', player:'IMAGES/Tristan.png', enemy:'IMAGES/enemy.png',
  vill1:'IMAGES/Villager1.jpg', vill2:'IMAGES/Villager2.jpg', house:'IMAGES/House.png', certified:'IMAGES/Certified.png'
};

let gameState = {
  mode:'title', // title / overworld / village / dungeon / battle
  biome:'grass',
  gold:0, lvl:1, xp:0, hp:12, maxhp:12,
  potions:0, hasMap:false,
  player:{x:12,y:6,px:0,py:0}, // tile coords and pixel overlay updated later
  tiles: [], // overworld tile map (TILE_TYPES chars)
  dungeon: null, // if in dungeon, object with maze grid and enemies
  currentEnemy: null,
  quests: []
};

/* DOM refs */
const tileGrid = document.getElementById('tile-grid');
const tileCanvas = document.getElementById('tile-canvas');
const visualPlayer = document.getElementById('visual-player');
const visualEnemy = document.getElementById('visual-enemy');
const minimap = document.getElementById('minimap');
const minimapPre = document.getElementById('minimap-pre');

const titleScreen = document.getElementById('title-screen');
const world = document.getElementById('world');
const villageView = document.getElementById('village-view');
const villageStage = document.getElementById('village-stage');
const dungeonView = document.getElementById('dungeon-view');
const dungeonCanvas = document.getElementById('dungeon-canvas');

const battleOverlay = document.getElementById('battle-overlay');
const battleEnemyImg = document.getElementById('battle-enemy-img');
const battlePlayerImg = document.getElementById('battle-player-img');
const battleLog = document.getElementById('battle-log');

const invPanel = document.getElementById('inventory');
const invList = document.getElementById('inv-list');
const shopModal = document.getElementById('shop-modal');
const shopList = document.getElementById('shop-list');

const titleAudio = document.getElementById('title-audio');
const dungeonAudio = document.getElementById('dungeon-audio');
const toggleMusicTitle = document.getElementById('toggle-music-title');

/* Helpers for DOM/UI updates */
function uiUpdate(){
  document.getElementById('gold').textContent = gameState.gold;
  document.getElementById('hud-gold').textContent = gameState.gold;
  document.getElementById('player-lvl').textContent = gameState.lvl;
  document.getElementById('hud-lvl').textContent = gameState.lvl;
  document.getElementById('hpdisplay').textContent = gameState.hp + ' / ' + gameState.maxhp;
  document.getElementById('hud-hp').textContent = gameState.hp + '/' + gameState.maxhp;
  document.getElementById('xpdisplay').textContent = (gameState.xp||0) + ' XP';
  document.getElementById('inv-list').innerHTML = '';
  addInvEntry('Potions', gameState.potions, 'Restores 6 HP when used.');
  addInvEntry('Map', gameState.hasMap?1:0, 'Reveals dungeon minimap when purchased.');
}
function addInvEntry(name,count,desc){
  const d = document.createElement('div'); d.className='inv-item';
  d.innerHTML = `<div><strong>${name}</strong><div class="inv-desc">${desc}</div></div><div style="text-align:right"><div>${count}</div><div style="margin-top:6px"><button class="btn inv-use" data-name="${name}">Use</button></div></div>`;
  invList.appendChild(d);
}

/* ======= Overworld generation & rendering ======= */
function generateOverworld(){
  const cols = CONFIG.cols, rows = CONFIG.rows;
  tileGrid.style.setProperty('--cols', cols);
  tileGrid.style.setProperty('--rows', rows);
  gameState.tiles = new Array(rows);
  // simple biome pick and tile generation: grass, villages, caves scattered
  const biome = BIOMES[Math.floor(Math.random()*BIOMES.length)];
  gameState.biome = biome.id;
  for(let y=0;y<rows;y++){
    gameState.tiles[y] = new Array(cols);
    for(let x=0;x<cols;x++){
      let t = 'G';
      // create paths occasionally
      if(Math.random() < 0.065) t = 'P';
      // villages (rare)
      if(Math.random() < 0.02) t = 'V';
      // caves (rare)
      if(Math.random() < 0.02) t = 'C';
      gameState.tiles[y][x] = t;
    }
  }
  // ensure center spawn is path
  gameState.player.x = Math.floor(cols/2);
  gameState.player.y = Math.floor(rows/2);
  gameState.tiles[gameState.player.y][gameState.player.x] = 'P';
  renderTiles();
  uiUpdate();
}
function renderTiles(){
  const cols = CONFIG.cols, rows = CONFIG.rows;
  tileGrid.innerHTML = '';
  tileGrid.style.setProperty('--cols', cols);
  tileGrid.style.setProperty('--rows', rows);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const t = document.createElement('div');
      t.className = 'tile';
      t.dataset.x = x; t.dataset.y = y;
      const type = gameState.tiles[y][x];
      if(type === 'C') { t.classList.add('cave'); }
      if(type === 'V') t.classList.add('village');
      // tint per biome overlay: we'll set background-color as overlay via inner div
      t.style.backgroundImage = `url('${ASSETS.grass || ASSETS.grass}')`;
      // apply tint
      const biome = BIOMES.find(b=>b.id===gameState.biome);
      if(biome) t.style.backgroundColor = biome.tint;
      tileGrid.appendChild(t);
    }
  }
  positionPlayerOverlay();
  if(gameState.hasMap) updateMinimap();
}
function positionPlayerOverlay(){
  const cols = CONFIG.cols, rows = CONFIG.rows;
  const px = gameState.player.x / (cols-1) * 100;
  const py = gameState.player.y / (rows-1) * 100;
  visualPlayer.style.left = px + '%';
  visualPlayer.style.top = py + '%';
  visualPlayer.style.transform = 'translate(-50%,-50%)';
}

/* ======= Movement on overworld (tile-step) ======= */
let lastStep = 0;
const stepDelay = 120;
document.addEventListener('keydown', (e)=>{
  if(gameState.mode === 'title') return;
  if(gameState.mode === 'village' || gameState.mode === 'battle' || gameState.mode === 'dungeon') return;
  const now = performance.now();
  if(now - lastStep < stepDelay) return;
  let nx = gameState.player.x, ny = gameState.player.y;
  if(e.key === 'w' || e.key === 'ArrowUp') ny--;
  else if(e.key === 's' || e.key === 'ArrowDown') ny++;
  else if(e.key === 'a' || e.key === 'ArrowLeft') nx--;
  else if(e.key === 'd' || e.key === 'ArrowRight') nx++;
  else return;
  if(nx < 0 || ny < 0 || nx >= CONFIG.cols || ny >= CONFIG.rows) return;
  gameState.player.x = nx; gameState.player.y = ny;
  positionPlayerOverlay();
  lastStep = now;
  const tile = gameState.tiles[ny][nx];
  if(tile === 'C'){ enterDungeon(); }
  else if(tile === 'V'){ enterVillage(); }
  else {
    // small chance to find coin etc.
    if(Math.random() < 0.04){ gameState.gold += 1; uiUpdate(); log('Found 1 coin while exploring!'); }
  }
  if(gameState.hasMap) updateMinimap();
});

/* quick log */
function log(text){
  const el = document.getElementById('log');
  if(!el) return;
  const d = document.createElement('div'); d.textContent = text;
  el.prepend(d);
}

/* ======= Village side-scroller (simple prototype) ======= */
function enterVillage(){
  gameState.mode = 'village';
  world.style.display = 'none';
  villageView.style.display = 'flex';
  // build a simple side-scroller layout based on biome
  villageStage.innerHTML = '';
  document.getElementById('village-title').textContent = (gameState.biome + ' Village').toUpperCase();
  // create houses
  const houseCount = 4 + Math.floor(Math.random()*3);
  for(let i=0;i<houseCount;i++){
    const h = document.createElement('div'); h.className='house';
    h.style.left = (i*260 + 60) + 'px';
    h.style.backgroundImage = `url('${ASSETS.house}')`;
    villageStage.appendChild(h);
    // random shop on one house
    if(i===1){
      const shopButton = document.createElement('div'); shopButton.className='btn';
      shopButton.textContent = 'Shop';
      shopButton.style.position='absolute'; shopButton.style.left = (i*260 + 120) + 'px'; shopButton.style.bottom='50px';
      shopButton.addEventListener('click', ()=>openShop());
      villageStage.appendChild(shopButton);
    }
  }
  // add villagers
  const v1 = document.createElement('div'); v1.className='villager'; v1.style.left='120px'; v1.style.bottom='48px'; v1.style.backgroundImage=`url('${ASSETS.vill1}')`; villageStage.appendChild(v1);
  const v2 = document.createElement('div'); v2.className='villager'; v2.style.left='420px'; v2.style.bottom='48px'; v2.style.backgroundImage=`url('${ASSETS.vill2}')`; villageStage.appendChild(v2);
}
document.getElementById('btn-village-return').addEventListener('click', ()=>{
  villageView.style.display='none'; world.style.display='block'; gameState.mode='overworld';
});

/* Shop UI */
function openShop(){
  shopModal.style.display = 'block';
  shopModal.querySelector('#shop-title').textContent = 'Village Shop';
  shopList.innerHTML = '';
  const items = [
    {id:'potion', name:'Potion', price:5, desc:'Restores 6 HP.'},
    {id:'map', name:'Dungeon Map', price:20, desc:'Reveals minimap while exploring dungeons.'}
  ];
  items.forEach(it=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px 0';
    row.innerHTML = `<div><strong>${it.name}</strong><div class="small">${it.desc}</div></div><div style="text-align:right"><div>${it.price} <img src="${ASSETS.certified}" width="14"></div><div style="margin-top:6px"><button class="btn shop-buy" data-id="${it.id}">Buy</button></div></div>`;
    shopList.appendChild(row);
  });
  // attach buy handlers
  shopList.querySelectorAll('.shop-buy').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const it = items.find(x=>x.id===id);
      if(gameState.gold < it.price) { alert('Not enough gold'); return; }
      gameState.gold -= it.price;
      if(id === 'potion') gameState.potions = (gameState.potions||0) + 1;
      if(id === 'map') gameState.hasMap = true;
      uiUpdate();
      alert('Purchased ' + it.name);
    };
  });
}
document.getElementById('shop-close').addEventListener('click', ()=>shopModal.style.display='none');

/* ======= Dungeon: maze generation, smooth movement, enemies ======= */
function enterDungeon(){
  // create a maze, spawn enemies, switch mode
  gameState.mode = 'dungeon';
  world.style.display = 'none';
  dungeonView.style.display = 'block';
  document.getElementById('dungeon-title').textContent = (gameState.biome + ' Dungeon').toUpperCase();
  // generate maze grid
  const w = 35, h = 20;
  const maze = generateMaze(w,h);
  gameState.dungeon = {w,h,maze,playerPos:{x:2,y:2,p_x:0,p_y:0}, enemies: []};
  placeDungeonEnemies(gameState.dungeon);
  renderDungeon();
  startDungeonLoop();
  updateAudio();
}
function leaveDungeon(){
  gameState.mode = 'overworld';
  dungeonView.style.display='none';
  world.style.display='block';
  gameState.dungeon = null;
  stopDungeonLoop();
  updateAudio();
}

/* simple recursive backtracker maze generator */
function generateMaze(w,h){
  // cell grid: 1 = wall, 0 = floor
  const grid = new Array(h).fill(0).map(()=>new Array(w).fill(1));
  function carve(x,y){
    grid[y][x]=0;
    const dirs = [[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
    for(const [dx,dy] of dirs){
      const nx=x+dx*2, ny=y+dy*2;
      if(nx>0 && nx<w-1 && ny>0 && ny<h-1 && grid[ny][nx]===1){
        grid[y+dy][x+dx]=0;
        carve(nx,ny);
      }
    }
  }
  carve(2,2);
  // ensure boundaries closed
  return grid;
}

/* spawn enemies in dungeon */
function placeDungeonEnemies(d){
  d.enemies = [];
  for(let i=0;i<CONFIG.dungeonEnemyCount;i++){
    // pick random floor cell
    let attempts=0;
    while(attempts++<300){
      const x = 2 + Math.floor(Math.random()*(d.w-4));
      const y = 2 + Math.floor(Math.random()*(d.h-4));
      if(d.maze[y][x] === 0 && (Math.abs(x - d.playerPos.x) + Math.abs(y - d.playerPos.y) > 6)){
        const tpl = ENEMY_TEMPLATES[gameState.biome] || ENEMY_TEMPLATES.grass;
        const enemy = {
          id: 'e'+i, name: tpl.name, hp: tpl.hp + Math.floor(Math.random()*4),
          maxhp: tpl.hp+3, atk: tpl.atk, x, y, px:0, py:0, state:'wander', ttl:0, act:tpl.act, gold: tpl.gold
        };
        d.enemies.push(enemy);
        break;
      }
    }
  }
}

/* render dungeon to canvas (tile-based simple) */
function renderDungeon(){
  const ctxArea = dungeonCanvas;
  const d = gameState.dungeon;
  ctxArea.innerHTML = ''; // clear
  ctxArea.style.setProperty('--dw', d.w);
  ctxArea.style.setProperty('--dh', d.h);
  // build a scaled container
  const cell = 28; // px per cell
  const totalW = d.w * cell, totalH = d.h * cell;
  const mapEl = document.createElement('div'); mapEl.style.position='absolute'; mapEl.style.left='50%'; mapEl.style.top='50%'; mapEl.style.width=totalW+'px'; mapEl.style.height=totalH+'px'; mapEl.style.transform='translate(-50%,-50%)'; mapEl.style.backgroundImage=`url('${ASSETS.stone||ASSETS.stone}')`; mapEl.style.backgroundSize='auto';
  // draw cells
  for(let y=0;y<d.h;y++){
    for(let x=0;x<d.w;x++){
      const c = document.createElement('div');
      c.style.position='absolute';
      c.style.left = (x*cell)+'px'; c.style.top = (y*cell)+'px';
      c.style.width = cell + 'px'; c.style.height = cell + 'px';
      if(d.maze[y][x]===1){
        c.style.background = 'rgba(40,40,45,0.95)';
      } else {
        c.style.background = 'rgba(90,90,100,0.06)';
      }
      mapEl.appendChild(c);
    }
  }
  ctxArea.appendChild(mapEl);
}

/* dungeon simulation: smooth player movement and enemy AI */
let dungeonInterval = null;
let dungeonLastTime = 0;
function startDungeonLoop(){
  dungeonLastTime = performance.now();
  dungeonInterval = requestAnimationFrame(dungeonStep);
}
function stopDungeonLoop(){ if(dungeonInterval) cancelAnimationFrame(dungeonInterval); dungeonInterval=null; }

const keys = {};
document.addEventListener('keydown', e=> keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);

function dungeonStep(now){
  const dt = (now - dungeonLastTime)/1000;
  dungeonLastTime = now;
  const d = gameState.dungeon;
  if(!d){ stopDungeonLoop(); return; }
  // player smooth movement (WASD)
  const speed = 120; // px/sec
  const cell = 28;
  // convert player tile pos to pixel inside rendered map coords
  const mapEl = dungeonCanvas.firstChild;
  if(mapEl){
    const player = d.playerPos;
    // update px/py (pixel-based centered at tile)
    if(!player.px) player.px = player.x * cell + cell/2;
    if(!player.py) player.py = player.y * cell + cell/2;
    let vx=0, vy=0;
    if(keys['w']||keys['arrowup']) vy -= speed*dt;
    if(keys['s']||keys['arrowdown']) vy += speed*dt;
    if(keys['a']||keys['arrowleft']) vx -= speed*dt;
    if(keys['d']||keys['arrowright']) vx += speed*dt;
    // attempt move, with collision
    const nx = player.px + vx, ny = player.py + vy;
    // test collision by checking cell at new center
    const gx = Math.floor(nx / cell), gy = Math.floor(ny / cell);
    if(gx >=0 && gy>=0 && gx < d.w && gy < d.h && d.maze[gy][gx] === 0){
      player.px = nx; player.py = ny;
      // update visual player position relative to canvas center
      const canvasRect = dungeonCanvas.getBoundingClientRect();
      visualPlayer.style.left = ((canvasRect.left + canvasRect.width/2 - totalElementCenterX()) + (player.px - (d.w*cell)/2)) + 'px';
      visualPlayer.style.top  = ((canvasRect.top  + canvasRect.height/2 - totalElementCenterY()) + (player.py - (d.h*cell)/2)) + 'px';
      // but simpler: place relative to dungeonCanvas center
      visualPlayer.style.left = (50 + (player.px - (d.w*cell)/2) / (dungeonCanvas.clientWidth) * 100) + '%';
      visualPlayer.style.top  = (50 + (player.py - (d.h*cell)/2) / (dungeonCanvas.clientHeight) * 100) + '%';
    }
    // enemy AI: wander, chase if within radius
    d.enemies.forEach(en=>{
      // px/py for enemy
      if(!en.px) { en.px = en.x * cell + cell/2; en.py = en.y * cell + cell/2; }
      // distance to player
      const dx = (player.px - en.px), dy = (player.py - en.py);
      const dist = Math.hypot(dx,dy);
      if(dist < 60){
        // chase
        const dirx = dx / dist, diry = dy / dist;
        en.px += dirx * 40 * dt; en.py += diry * 40 * dt;
      } else {
        // wander
        en.px += (Math.random()-0.5) * 20 * dt;
        en.py += (Math.random()-0.5) * 20 * dt;
      }
      // update visual enemy marker relative to dungeon canvas (simpler mapping)
      visualEnemy.style.left = (50 + (en.px - (d.w*cell)/2) / (dungeonCanvas.clientWidth) * 100) + '%';
      visualEnemy.style.top  = (50 + (en.py - (d.h*cell)/2) / (dungeonCanvas.clientHeight) * 100) + '%';
      // collision check: if distance small -> trigger battle
      if(Math.hypot(player.px - en.px, player.py - en.py) < 22){
        // begin battle with this enemy
        startBattle(en);
      }
    });
  }
  dungeonInterval = requestAnimationFrame(dungeonStep);
}

/* utility placeholders for center calcs (used above) */
function totalElementCenterX(){ return 0; } function totalElementCenterY(){ return 0; }

/* ======= Battle system (Pokémon-like overlay) ======= */
function startBattle(enemy){
  if(gameState.mode === 'battle') return;
  gameState.mode = 'battle';
  gameState.currentEnemy = enemy;
  // set battle UI
  battleEnemyImg.src = ASSETS.enemy;
  battlePlayerImg.src = ASSETS.player;
  document.getElementById('battle-enemy-name').textContent = enemy.name;
  document.getElementById('battle-enemy-hp').textContent = 'HP: ' + enemy.hp;
  document.getElementById('battle-player-hp').textContent = 'HP: ' + gameState.hp;
  battleLog.textContent = `${enemy.name} encountered you!`;
  battleOverlay.style.display = 'flex';
  updateAudio();
}

function endBattleUI(){
  battleOverlay.style.display = 'none';
  gameState.currentEnemy = null;
  // if in dungeon, remove enemy from list (simulate drop)
  if(gameState.dungeon){
    const d = gameState.dungeon;
    d.enemies = d.enemies.filter(en => en.hp > 0);
    // chance to drop item
    if(Math.random() < CONFIG.enemyDropChance){
      // rare gear -> here simplified as potion or gold
      if(Math.random() < 0.5){ gameState.potions = (gameState.potions||0) + 1; log('Enemy dropped a potion!'); }
      else { gameState.gold += 5; log('Enemy dropped some coins!'); }
      uiUpdate();
    }
  }
  gameState.mode = (gameState.dungeon? 'dungeon' : 'overworld');
  updateAudio();
}

/* battle actions */
document.getElementById('battle-fight').addEventListener('click', ()=>{
  if(gameState.mode !== 'battle') return;
  const e = gameState.currentEnemy;
  if(!e) return;
  const dmg = 2 + Math.floor(gameState.lvl/2) + Math.floor(Math.random()*3);
  e.hp -= dmg;
  battleLog.textContent = `You hit ${e.name} for ${dmg} damage.`;
  // shake
  battleEnemyImg.classList.add('shake'); setTimeout(()=>battleEnemyImg.classList.remove('shake'),420);
  document.getElementById('battle-enemy-hp').textContent = 'HP: ' + Math.max(0,e.hp);
  if(e.hp <= 0){
    battleLog.textContent = `${e.name} fainted!`;
    // reward
    gameState.gold += e.gold || 1;
    gameState.xp += 3 + Math.floor(Math.random()*3);
    uiUpdate();
    setTimeout(()=> endBattleUI(),800);
  } else {
    setTimeout(()=> enemyTurn(e), 500);
  }
});
document.getElementById('battle-act').addEventListener('click', ()=>{
  const e = gameState.currentEnemy; if(!e) return;
  battleLog.textContent = e.act || 'You act...';
  // small chance to pacify or buff/nerf
  if(Math.random() < 0.33){ battleLog.textContent += ' It seems calmer.'; e.atk = Math.max(1, (e.atk||2)-1); }
  else { battleLog.textContent += ' It growls angrily.'; e.atk = (e.atk||2)+1; }
  setTimeout(()=> enemyTurn(e),600);
});
document.getElementById('battle-item').addEventListener('click', ()=>{
  if(gameState.potions && gameState.potions>0){
    gameState.potions--; const heal = Math.min(gameState.maxhp - gameState.hp, 6); gameState.hp += heal;
    battleLog.textContent = `You used a potion and recovered ${heal} HP.`; uiUpdate();
    setTimeout(()=> enemyTurn(gameState.currentEnemy),600);
  } else battleLog.textContent = 'No items available.';
});
document.getElementById('battle-flee').addEventListener('click', ()=>{
  // chance depends on enemy atk vs level
  const e = gameState.currentEnemy; if(!e) return;
  const chance = 0.45 + (gameState.lvl - (e.atk||1))*0.03;
  if(Math.random() < chance){
    battleLog.textContent = 'You escaped!';
    setTimeout(()=> endBattleUI(),600);
  } else { battleLog.textContent = 'Failed to escape!'; setTimeout(()=> enemyTurn(e),500); }
});
function enemyTurn(e){
  if(!e) return;
  const dmg = Math.max(1, (e.atk||2) + Math.floor(Math.random()*2));
  gameState.hp -= dmg;
  document.getElementById('battle-player-hp').textContent = 'HP: ' + gameState.hp;
  battleLog.textContent = `${e.name} hits you for ${dmg} damage.`;
  battlePlayerImg.classList.add('shake'); setTimeout(()=>battlePlayerImg.classList.remove('shake'),420);
  if(gameState.hp <= 0){
    battleLog.textContent = 'You were defeated...';
    setTimeout(()=> {
      // respawn at overworld center, lose half gold
      gameState.gold = Math.max(0, Math.floor(gameState.gold/2));
      gameState.hp = gameState.maxhp;
      uiUpdate();
      endBattleUI();
    }, 1000);
  }
}

/* ======= Inventory & shop usage ======= */
document.getElementById('btn-inventory').addEventListener('click', ()=>{ invPanel.style.display='block'; });
document.getElementById('inv-close').addEventListener('click', ()=>{ invPanel.style.display='none'; });
document.addEventListener('click', (ev)=>{
  if(ev.target && ev.target.classList && ev.target.classList.contains('inv-use')){
    const name = ev.target.dataset.name;
    if(name === 'Potions'){ if(gameState.potions>0){ gameState.potions--; gameState.hp = Math.min(gameState.hp + 6, gameState.maxhp); uiUpdate(); alert('Used potion'); } else alert('No potions'); }
    if(name === 'Map'){ alert(gameState.hasMap? 'Map active.' : 'You do not own a map.'); }
  }
});

/* ======= Minimap (revealed by buying Map) ======= */
function updateMinimap(){
  if(!gameState.hasMap){ minimap.style.display='none'; return; }
  minimap.style.display='block';
  const rows = CONFIG.rows, cols = CONFIG.cols;
  let s = '';
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(x===gameState.player.x && y===gameState.player.y) s += '@';
      else {
        const t = gameState.tiles[y][x];
        if(t==='C') s += 'C';
        else if(t==='V') s += 'V';
        else if(t==='P') s += '.';
        else s += '.';
      }
    }
    s += '\n';
  }
  minimapPre.textContent = s;
}

/* ======= Save / Load ======= */
const SAVE_KEY = 'tristan_proto_save_v1';
document.getElementById('btn-save').addEventListener('click', ()=>{
  const save = {...gameState};
  save.tiles = gameState.tiles;
  localStorage.setItem(SAVE_KEY, JSON.stringify(save));
  alert('Game saved.');
});
document.getElementById('btn-new').addEventListener('click', ()=>{ titleScreen.style.display='none'; startNewGame(); });
document.getElementById('btn-load').addEventListener('click', ()=>{
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ alert('No save found'); return; }
  const s = JSON.parse(raw);
  gameState = {...gameState, ...s};
  uiUpdate(); renderTiles();
  titleScreen.style.display='none';
});
document.getElementById('btn-return').addEventListener('click', ()=>{ if(confirm('Return to title?')) { location.reload(); }});

/* Tutorial entry */
document.getElementById('btn-tut').addEventListener('click', ()=>{
  titleScreen.style.display='none';
  // quick tutorial: fight Walter in battle overlay
  startBattle({name:'Walter', hp:14, atk:2, act:'Walter says: That is ACT!'});
});

/* village map button */
document.getElementById('btn-map').addEventListener('click', ()=>{ alert('Full map view (todo)'); });

/* shop close */
document.getElementById('shop-close').addEventListener('click', ()=>shopModal.style.display='none');

/* dungeon leave */
document.getElementById('btn-dungeon-leave').addEventListener('click', ()=>{ if(confirm('Leave dungeon?')) leaveDungeon();});

/* music control */
toggleMusicTitle.addEventListener('change', updateAudio);
function updateAudio(){
  const on = toggleMusicTitle.checked;
  if(!on){ titleAudio.pause(); dungeonAudio.pause(); return; }
  if(gameState.mode === 'title'){ titleAudio.play().catch(()=>{}); dungeonAudio.pause(); }
  else if(gameState.mode === 'dungeon'){ dungeonAudio.play().catch(()=>{}); titleAudio.pause(); }
  else { titleAudio.pause(); dungeonAudio.pause(); }
}

/* ====== Utility: initialization ====== */
function startNewGame(){
  gameState = {...gameState, mode:'overworld', gold:12, lvl:1, xp:0, hp:12, maxhp:12, potions:1, hasMap:false, quests:[]};
  generateOverworld();
  uiUpdate();
  gameState.mode = 'overworld';
  updateAudio();
  titleScreen.style.display='none';
}
updateAudio();

/* small initial render when page loads */
window.addEventListener('load', ()=>{
  generateOverworld();
  uiUpdate();
  renderTiles();
});

</script>
</body>
</html>
